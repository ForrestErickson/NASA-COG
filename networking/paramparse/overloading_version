#include <stdio.h>
#include <string.h>
#include <stdlib.h>

char udpbuffer[2048] = "Name. Test Name \n\
TimeStamp. 1680759024\n\
DryRun. TRUE\n\
Nonce. 123\n\
MaxRampUp. 10\n\
MaxRampDown. 10\n\
[[ StateName. WarmUp\n\
[ Phases.Offset. 0\n\
Phases.Fan.Speed. 0\n\
Phases.Fan.Flow. 0\n\
Phases.Preheat.Temp. 0\n\
Phases.Preheat.Current. 0\n\
Phases.Preheat.Ramp. 0\n\
Phases.Stack.Temp. 0\n\
Phases.Stack.Current. 0\n\
Phases.Stack.Ramp. 0\n\
[ Phases.Offset. 0\n\
Phases.Fan.Speed. 0\n\
Phases.Fan.Flow. 0\n\
Phases.Preheat.Temp. 0\n\
Phases.Preheat.Current. 0\n\
Phases.Preheat.Ramp. 0\n\
Phases.Stack.Temp. 0\n\
Phases.Stack.Current. 0\n\
Phases.Stack.Ramp. 0\n\
[[ StateName. Cooldown\n\
[ Phases.Offset. 0\n\
Phases.Fan.Speed. 0\n\
Phases.Fan.Flow. 0\n\
Phases.Preheat.Temp. 0\n\
Phases.Preheat.Current. 0\n\
Phases.Preheat.Ramp. 0\n\
Phases.Stack.Temp. 0\n\
Phases.Stack.Current. 0\n\
Phases.Stack.Ramp. 0\n\
[ Phases.Offset. 0\n\
Phases.Fan.Speed. 0\n\
Phases.Fan.Flow. 0\n\
Phases.Preheat.Temp. 0\n\
Phases.Preheat.Current. 0\n\
Phases.Preheat.Ramp. 0\n\
Phases.Stack.Temp. 0\n\
Phases.Stack.Current. 0\n\
Phases.Stack.Ramp. 0\n\
[[ StateName. EmergencyShutdown\n\
[ Phases.Offset. 0\n\
Phases.Fan.Speed. 0\n\
Phases.Fan.Flow. 0\n\
Phases.Preheat.Temp. 0\n\
Phases.Preheat.Current. 0\n\
Phases.Preheat.Ramp. 0\n\
Phases.Stack.Temp. 0\n\
Phases.Stack.Current. 0\n\
Phases.Stack.Ramp. 0\n\
[ Phases.Offset. 0\n\
Phases.Fan.Speed. 0\n\
Phases.Fan.Flow. 0\n\
Phases.Preheat.Temp. 0\n\
Phases.Preheat.Current. 0\n\
Phases.Preheat.Ramp. 0\n\
Phases.Stack.Temp. 0\n\
Phases.Stack.Current. 0\n\
Phases.Stack.Ramp. 0\n\
[[ StateName. Operation\n\
[ Phases.Offset. 0\n\
Phases.Fan.Speed. 0\n\
Phases.Fan.Flow. 0\n\
Phases.Preheat.Temp. 0\n\
Phases.Preheat.Current. 0\n\
Phases.Preheat.Ramp. 0\n\
Phases.Stack.Temp. 0\n\
Phases.Stack.Current. 0\n\
Phases.Stack.Ramp. 0\n\
[ Phases.Offset. 0\n\
Phases.Fan.Speed. 0\n\
Phases.Fan.Flow. 0\n\
Phases.Preheat.Temp. 0\n\
Phases.Preheat.Current. 0\n\
Phases.Preheat.Ramp. 0\n\
Phases.Stack.Temp. 0\n\
Phases.Stack.Current. 0\n\
Phases.Stack.Ramp. 0\n\
";

char *gName = NULL;
char *gTimestamp = NULL;
int gDryRun = 1;
int gNonce = -1;
int gMaxRampUp = 1;
int gMaxRampDown = 2;
char *gWarmUp = NULL;
char *gCooldown = NULL;
char *gEmShutdown = NULL;
char *gOperation = NULL;

int parse_param(const char *value, char **rvalue) {
  char *item = strstr(udpbuffer, value);
  if (!item) return 0;

  if (*rvalue) free(*rvalue);

  item += strlen(value);
  while (*item == ' ' || *item == '.') item++;
  char *end = strchr(item, '\n');
  *end = '\0';
  *rvalue = (char *)malloc(strlen(item) + 1);
  strcpy(*rvalue, item);
  *end = '\n';
  return 1;
}

int parse_param(const char *value, int *rvalue) {
  char *item = strstr(udpbuffer, value);
  if (!item) return 0;

  item += strlen(value);
  while (*item == ' ' || *item == '.') item++;
  char *end = strchr(item, '\n');
  *end = '\0';
  if (strncasecmp(item, "On", 2) == 0) *rvalue = 1;
  else if (strncasecmp(item, "Yes", 3) == 0) *rvalue = 1;
  else if (strncasecmp(item, "True", 4) == 0) *rvalue = 1;
  else if (strncasecmp(item, "Off", 3) == 0) *rvalue = 0;
  else if (strncasecmp(item, "No", 2) == 0) *rvalue = 0;
  else if (strncasecmp(item, "False", 5) == 0) *rvalue = 0;
  else *rvalue = atoi(item);
  *end = '\n';
  return 1;
}

int parse_param_state(const char *value, char **rvalue) {
  char str[strlen(value) + 15];
  sprintf(str, "[[ StateName. %s", value);
  char *item = strstr(udpbuffer, str);
  if (!item) return 0;

  if (*rvalue) free(*rvalue);

  item += strlen(str);
  while (*item == ' ' || *item == '\n') item++;

  char *end = strstr(item, "[[");
  if (end) *--end = '\0';
  else {
    end = strrchr(item, '\n');
    *end = '\0';
  }
  *rvalue = (char *)malloc(strlen(item) + 1);
  strcpy(*rvalue, item);
  if (end) *end = '\n';
  return 1;
}

int main(int argc, char *argv[]) {
  char *temp;

  int tempnonce = 0;
  parse_param("Nonce", &tempnonce);
  if (tempnonce <= gNonce) exit(1);
  gNonce = tempnonce;
  
  parse_param("Name", &gName);
  parse_param("TimeStamp", &gTimestamp);
  parse_param("DryRun", &gDryRun);
  parse_param("MaxRampUp", &gMaxRampUp);
  parse_param("MaxRampDown", &gMaxRampDown);

  parse_param_state("WarmUp", &gWarmUp);
  parse_param_state("CoolDown", &gCooldown);
  parse_param_state("EmergencyShutdown", &gEmShutdown);
  parse_param_state("Operation", &gOperation);

  printf("Name is %s\n", gName);
  printf("Timestamp is %s\n", gTimestamp);
  printf("Dryrun is %s\n", gDryRun ? "True" : "False");
  printf("Nonce is %d\n", gNonce);
  printf("Max UP is %d\n", gMaxRampUp);
  printf("Max DOWN is %d\n", gMaxRampDown);
  printf("Warmup Script:\n%s\n----\n", gWarmUp);
  printf("Cooldown Script:\n%s\n----\n", gCooldown);
  printf("Emergency Script:\n%s\n----\n", gEmShutdown);
  printf("Operation Script:\n%s\n----\n", gOperation);
}
